From d470dedf740961ab9a50a04740f9a6909e1e0bfc Mon Sep 17 00:00:00 2001
From: Nick Wellnhofer <wellnhofer@aevum.de>
Date: Mon, 5 Aug 2024 14:58:37 +0200
Subject: [PATCH] parser: Fix error handling after reaching limit

From 239e25f613cb0d63bb26ebae433fcc4a9e0cee16 Mon Sep 17 00:00:00 2001
From: Nick Wellnhofer <wellnhofer@aevum.de>
Date: Mon, 5 Aug 2024 15:14:21 +0200
Subject: [PATCH] parser: Report at least one fatal error

Index: parserInternals.c
--- parserInternals.c.orig
+++ parserInternals.c
@@ -253,11 +253,13 @@ xmlCtxtVErr(xmlParserCtxtPtr ctxt, xmlNodePtr node, xm
 
     if (level == XML_ERR_WARNING) {
         if (ctxt->nbWarnings >= XML_MAX_ERRORS)
-            return;
+            goto done;
         ctxt->nbWarnings += 1;
     } else {
-        if (ctxt->nbErrors >= XML_MAX_ERRORS)
-            return;
+        /* Report at least one fatal error. */
+        if ((ctxt->nbErrors >= XML_MAX_ERRORS) &&
+            ((level < XML_ERR_FATAL) || (ctxt->wellFormed == 0)))
+            goto done;
         ctxt->nbErrors += 1;
     }
 
@@ -308,6 +310,7 @@ xmlCtxtVErr(xmlParserCtxtPtr ctxt, xmlNodePtr node, xm
         return;
     }
 
+done:
     if (level >= XML_ERR_ERROR)
         ctxt->errNo = code;
     if (level == XML_ERR_FATAL) {
