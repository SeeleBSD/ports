COMMENT-main=		text based music notation system
COMMENT-docs=		lilypond documentation

VERSION=		2.24.4
DISTNAME=		lilypond-v${VERSION}
DISTNAME-docs=		lilypond-${VERSION}-documentation
PKGNAME-main=		lilypond-${VERSION}
PKGNAME-docs=		lilypond-docs-${VERSION}
CATEGORIES=		print

URW_V=			20200910
DISTFILES=		${DISTNAME}.tar.bz2
DISTFILES.doc=		${DISTNAME-docs}.tar.xz
DISTFILES.urw =		urw-base35-fonts-${URW_V}.tar.gz
EXTRACT_ONLY=		${DISTFILES} ${DISTFILES.urw}

MULTI_PACKAGES=		-main -docs

HOMEPAGE=		https://lilypond.org/

MAINTAINER=		Matthias Kilian <kili@openbsd.org>

# GPLv3+, for urw-base35-fonts: AGPLv3 with font exception
PERMIT_PACKAGE=	Yes

COMPILER =		base-clang ports-gcc base-gcc

SITE_BASE=		https://gitlab.com/lilypond/lilypond/-/
SITES=			${SITE_BASE}archive/v${VERSION}/
SITES.doc=		${SITE_BASE}releases/v${VERSION}/downloads/
SITES.urw=		https://github.com/ArtifexSoftware/urw-base35-fonts/archive/${URW_V}/

# We don't use the standard autoconf mechanisms from the ports
# system, because it doesn't work for lilypond. Instead, we use
# autogen.sh and add AUTOCONV_VERSION to the environment.
AUTOCONF_VERSION=	2.69
CONFIGURE_STYLE=	gnu
CONFIGURE_SCRIPT=	autogen.sh
CONFIGURE_ENV=		AUTOCONF_VERSION=${AUTOCONF_VERSION} \
			BASH=/bin/sh \
			GREP=/usr/bin/grep \
			GUILE_FLAVOR=guile-2.2 \
			LDFLAGS=-L${LOCALBASE}/lib
CONFIGURE_ARGS+=	--disable-debugging \
			--disable-documentation \
			--disable-optimising \
			--disable-pipe

USE_GMAKE=		Yes
MAKE_FILE=		GNUmakefile

# Stupid fontforge writes autosave data to ~/.PfaEdit, even in
# scripting mode, so give it a HOME to stop systrace warnings.
PORTHOME=		${WRKDIR}

PKG_ARCH-docs=		*
WANTLIB-docs =
LIB_DEPENDS-docs=
RUN_DEPENDS-docs=

WANTLIB-main=		c fontconfig freetype gc glib-2.0 gobject-2.0 \
			guile-2.2 harfbuzz intl m pango-1.0 \
			pangoft2-1.0 pthread \
			${COMPILER_LIBCXX}
MODULES=		lang/python
MODPY_VERSION =	${MODPY_DEFAULT_VERSION_3}
LIB_DEPENDS-main=	devel/gettext,-runtime \
			lang/guile2 \
			devel/glib2 \
			devel/pango
RUN_DEPENDS=		print/ghostscript/gnu
BUILD_DEPENDS= 		print/fontforge \
			print/t1utils \
			print/texlive/texmf \
			devel/bison \
			devel/gettext,-tools \
			devel/autoconf/${AUTOCONF_VERSION} \
			${RUN_DEPENDS}

SUBST_VARS+=		VERSION

ALL_TARGET=		all bytecode
INSTALL_TARGET+=	install install-bytecode

# Extract the documentation distfiles.
# Remove files generated by bison to avoid some recompilations
# during fake stage.
post-extract:
	@xz -cd ${FULLDISTDIR}/${DISTNAME-docs}.tar.xz | \
		pax -rs '!^\.!${WRKDIR}/docs!'
	@rm -rf ${WRKSRC}/lily/out

LILYFONTDIR=	${PREFIX}/share/lilypond/${VERSION}/fonts/otf
TEXGYREDIR=	${LOCALBASE}/share/texmf-dist/fonts/opentype/public/tex-gyre
URWDIR=		${WRKDIR}/urw-base35-fonts-${URW_V}/fonts
post-install:
	${INSTALL_DATA_DIR} ${PREFIX}/share/doc/lilypond/${VERSION}
	umask 022 && cp -R ${WRKDIR}/docs/share/doc/lilypond/html/* \
		${PREFIX}/share/doc/lilypond/${VERSION}
	for f in ${WRKDIR}/docs/share/man/man1/*; do \
		${INSTALL_MAN} $$f ${PREFIX}/man/man1; \
	done; \
	for f in cursor heros schola; do \
		for s in regular bold bolditalic italic; do \
			${INSTALL_DATA} ${TEXGYREDIR}/texgyre$$f-$$s.otf \
				${LILYFONTDIR}; \
		done; \
	done; \
	for s in Roman BdIta Bold Italic; do \
		${INSTALL_DATA} ${URWDIR}/C059-$$s.otf ${LILYFONTDIR}; \
	done; \
	for f in NimbusMonoPS NimbusSans; do \
		for s in Regular Bold BoldItalic Italic; do \
			${INSTALL_DATA} ${URWDIR}/$$f-$$s.otf \
				${LILYFONTDIR}; \
		done; \
	done


# Regression tests disabled, because we don't build the documentation.
NO_TEST=		Yes

.include <bsd.port.mk>
